- hosts: all
  become: yes
  vars_files:
    - ../vars/main.yml
    - ../vars/{{ ansible_os_family }}.yml

  pre_tasks:
    - name: Update system packages
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install basic utilities
      package:
        name:
          - curl
          - wget
          - git
          - htop
          - net-tools
        state: present

  roles:
    - { role: docker, tags: ['docker'] }
    - { role: kubernetes, tags: ['kubernetes'] }
    - { role: monitoring, tags: ['monitoring'] }
    - { role: logging, tags: ['logging'] }

  post_tasks:
    - name: Verify installations
      command: "{{ item }}"
      register: version_check
      loop:
        - docker --version
        - kubectl version --client

    - name: Display versions
      debug:
        msg: "{{ version_check.results }}"